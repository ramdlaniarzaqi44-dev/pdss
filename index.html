<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Tabulasi & Peringkat Rapor (STAR)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Versi Modular - Bridge to Global) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose functions to global scope so React (Babel) can use them
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            getDoc 
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Custom Table Styles */
        .spreadsheet-table { border-collapse: collapse; width: 100%; font-size: 12px; }
        .spreadsheet-table th, .spreadsheet-table td { border: 1px solid #e2e8f0; padding: 6px 10px; }
        .spreadsheet-table th { background-color: #f8fafc; font-weight: 600; text-align: left; position: sticky; top: 0; }
        .spreadsheet-table tr.existing { background-color: #f0fdf4; } /* Green tint */
        .spreadsheet-table tr.new { background-color: #eff6ff; } /* Blue tint */
        .spreadsheet-table tr.invalid { background-color: #fef2f2; } /* Red tint */
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICON HELPER ---
        const createIcon = (iconName) => ({ size = 24, className = "", ...props }) => {
            // Wait for Lucide to load
            if (!window.lucide) return <span className="text-xs">...</span>;
            
            const iconData = window.lucide.icons[iconName];
            if (!iconData) return null;
            
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // Icons
        const Trophy = createIcon('Trophy');
        const Users = createIcon('Users');
        const BarChart3 = createIcon('BarChart3');
        const Plus = createIcon('Plus');
        const Search = createIcon('Search');
        const Trash2 = createIcon('Trash2');
        const Save = createIcon('Save');
        const FileSpreadsheet = createIcon('FileSpreadsheet');
        const ChevronRight = createIcon('ChevronRight');
        const X = createIcon('X');
        const BookOpen = createIcon('BookOpen');
        const Settings = createIcon('Settings');
        const ClipboardPaste = createIcon('ClipboardPaste');
        const ArrowDown = createIcon('ArrowDown');
        const FileUp = createIcon('FileUp');
        const AlertCircle = createIcon('AlertCircle');
        const Download = createIcon('Download');
        const CheckCircle = createIcon('CheckCircle');
        const UploadCloud = createIcon('UploadCloud');
        const UserPlus = createIcon('UserPlus');
        const FileDown = createIcon('FileDown');
        const Award = createIcon('Award'); 
        const HeartHandshake = createIcon('HeartHandshake');
        const Cloud = createIcon('Cloud');
        const WifiOff = createIcon('WifiOff');
        const Filter = createIcon('Filter');
        const UserMinus = createIcon('UserMinus'); 
        const UserCheck = createIcon('UserCheck');

        // --- KONFIGURASI SEMESTER ---
        const SEMESTERS = [
            { id: 1, label: 'Sem 1 (Kls 10)', level: 10 },
            { id: 2, label: 'Sem 2 (Kls 10)', level: 10 },
            { id: 3, label: 'Sem 3 (Kls 11)', level: 11 },
            { id: 4, label: 'Sem 4 (Kls 11)', level: 11 },
            { id: 5, label: 'Sem 5 (Kls 12)', level: 12 },
        ];

        // --- DATA DEFAULT ---
        const DEFAULT_SUBJECTS = [
            { id: 'mtk', name: 'Matematika', levels: [10, 11, 12], alias: ['MATEMATIKA', 'MATH'] },
            { id: 'ind', name: 'B. Indonesia', levels: [10, 11, 12], alias: ['BAHASA INDONESIA', 'B. INDO', 'INDONESIA'] },
            { id: 'ing', name: 'B. Inggris', levels: [10, 11, 12], alias: ['BAHASA INGGRIS', 'B. ING', 'INGGRIS'] },
            { id: 'fis', name: 'Fisika', levels: [10, 11, 12], alias: ['FISIKA'] },
            { id: 'kim', name: 'Kimia', levels: [10, 11, 12], alias: ['KIMIA'] },
            { id: 'bio', name: 'Biologi', levels: [10, 11, 12], alias: ['BIOLOGI'] },
            { id: 'eko', name: 'Ekonomi', levels: [10, 11, 12], alias: ['EKONOMI'] },
            { id: 'sej', name: 'Sejarah', levels: [10, 11, 12], alias: ['SEJARAH'] }
        ];

        const INITIAL_STUDENTS = [
            {
                id: 1701,
                name: "Andi Saputra",
                nis: "2122001",
                nisn: "0051234567",
                class: "12 IPA 1",
                grades: { 1: { mtk: 85 }, 2: { mtk: 87 }, 3: { mtk: 88 }, 4: { mtk: 90 }, 5: { mtk: 92 } }
            },
            {
                id: 1702,
                name: "Budi Santoso",
                nis: "2122002",
                nisn: "0057654321",
                class: "12 IPA 2",
                grades: { 1: { mtk: 75 }, 2: { mtk: 77 }, 3: { mtk: 78 }, 4: { mtk: 80 }, 5: { mtk: 82 } }
            }
        ];

        // --- COMPONENTS ---
        const Card = ({ title, value, icon, color }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center space-x-4">
                <div className={`p-3 rounded-lg ${color} text-white`}>
                    {icon}
                </div>
                <div>
                    <p className="text-sm text-slate-500 font-medium">{title}</p>
                    <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-4xl" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`bg-white rounded-xl shadow-2xl w-full ${maxWidth} max-h-[90vh] overflow-y-auto flex flex-col animate-fade-in`}>
                        <div className="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10 flex-shrink-0">
                            <h2 className="text-xl font-bold text-slate-800">{title}</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-6 flex-1 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState(null);
            const [isOnline, setIsOnline] = useState(false);
            const [permissionError, setPermissionError] = useState(false);

            const [students, setStudents] = useState([]);
            const [subjects, setSubjects] = useState([]);
            const [rejectedStudents, setRejectedStudents] = useState([]);
            const [loading, setLoading] = useState(true);

            const [view, setView] = useState('dashboard'); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSubjectModalOpen, setIsSubjectModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false); 
            const [editingStudent, setEditingStudent] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [activeSemesterInput, setActiveSemesterInput] = useState(1);
            const [pasteMode, setPasteMode] = useState(false);
            const [importSemester, setImportSemester] = useState(1); 
            const [eligibleQuota, setEligibleQuota] = useState(10);
            
            const [rankFilter, setRankFilter] = useState('ALL');
            const [eligibleFilter, setEligibleFilter] = useState('ALL');

            const [rejectSearch, setRejectSearch] = useState("");
            const [rejectReason, setRejectReason] = useState("");
            const [selectedRejectStudent, setSelectedRejectStudent] = useState(null);
            const [isSavingRejection, setIsSavingRejection] = useState(false);

            const [currentGrades, setCurrentGrades] = useState({});

            const [importStage, setImportStage] = useState('upload'); 
            const [previewData, setPreviewData] = useState([]); 
            const [importStats, setImportStats] = useState({ updated: 0, new: 0, invalid: 0 });
            
            const [newSubjectName, setNewSubjectName] = useState("");
            const [activeLevelTab, setActiveLevelTab] = useState(10); 

            useEffect(() => {
                const initFirebase = async () => {
                    const checkModules = setInterval(async () => {
                        if (window.firebaseModules) {
                            clearInterval(checkModules);
                            const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore } = window.firebaseModules;
                            try {
                                const firebaseConfig = {
  apiKey: "AIzaSyDVoiRGqGJynXm2Yn-Uwbjly94wiUyRPhQ",
  authDomain: "pdss-sma.firebaseapp.com",
  projectId: "pdss-sma",
  storageBucket: "pdss-sma.firebasestorage.app",
  messagingSenderId: "253347223286",
  appId: "1:253347223286:web:0372926aa6ccc324e57ed7"
};
                                
                                const app = initializeApp(firebaseConfig);
                                const auth = getAuth(app);
                                const firestore = getFirestore(app);
                                const currentAppId = 'pdss-bk-app'; 
                                
                                setDb(firestore); 
                                setAppId(currentAppId);
                                
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                                    else {
                                        // Fallback to anonymous if no token (standard for these demos)
                                        await signInAnonymously(auth);
                                    }
                                } catch (authError) { 
                                    console.warn("Auth fallback:", authError);
                                    await signInAnonymously(auth); 
                                }
                                
                                onAuthStateChanged(auth, (u) => { setUser(u); setIsOnline(!!u); });
                            } catch (error) { 
                                console.error("Firebase Init Error:", error); 
                                setLoading(false); 
                            }
                        }
                    }, 100);
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!user || !db || !appId) return;
                const { collection, onSnapshot, doc, setDoc } = window.firebaseModules;
                
                // --- Subjects Sync ---
                const subRef = collection(db, 'artifacts', appId, 'public', 'data', 'subjects_v1');
                const unsubSub = onSnapshot(subRef, (snapshot) => {
                    const loadedSubjects = snapshot.docs.map(d => d.data());
                    if (loadedSubjects.length === 0 && !snapshot.metadata.fromCache) {
                        // Init defaults if empty
                        DEFAULT_SUBJECTS.forEach(s => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects_v1', s.id), s));
                    } else setSubjects(loadedSubjects);
                }, (error) => {
                    if(error.code === 'permission-denied') setPermissionError(true);
                    setLoading(false);
                });

                // --- Students Sync ---
                const stuRef = collection(db, 'artifacts', appId, 'public', 'data', 'students_v1');
                const unsubStu = onSnapshot(stuRef, (snapshot) => {
                    const loadedStudents = snapshot.docs.map(d => d.data());
                    if (loadedStudents.length === 0 && !snapshot.metadata.fromCache) {
                        // Init defaults if empty
                        INITIAL_STUDENTS.forEach(s => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students_v1', String(s.id)), s));
                    } else setStudents(loadedStudents);
                    setLoading(false);
                }, (error) => {
                    if(error.code === 'permission-denied') setPermissionError(true);
                    setLoading(false);
                });

                // --- Rejections Sync ---
                const rejRef = collection(db, 'artifacts', appId, 'public', 'data', 'rejected_students_v1');
                const unsubRej = onSnapshot(rejRef, (snapshot) => {
                    const loadedRej = snapshot.docs.map(d => d.data());
                    setRejectedStudents(loadedRej);
                }, (error) => {
                    if(error.code === 'permission-denied') setPermissionError(true);
                });

                return () => { unsubSub(); unsubStu(); unsubRej(); };
            }, [user, db, appId]);

            useEffect(() => {
                if (isModalOpen) {
                    if (editingStudent) setCurrentGrades(JSON.parse(JSON.stringify(editingStudent.grades || {})));
                    else setCurrentGrades({});
                }
            }, [isModalOpen, editingStudent]);

            const updateCurrentGrades = (semId, subId, value) => {
                setCurrentGrades(prev => {
                    const semGrades = { ...(prev[semId] || {}) };
                    semGrades[subId] = parseInt(value) || 0;
                    return { ...prev, [semId]: semGrades };
                });
            };

            const dbSaveStudent = async (studentData) => {
                if(!db) return;
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students_v1', String(studentData.id)), studentData);
            };
            const dbDeleteStudent = async (id) => {
                if(!db) return;
                const { doc, deleteDoc } = window.firebaseModules;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students_v1', String(id)));
            };
            const dbSaveSubject = async (subjectData) => {
                if(!db) return;
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects_v1', subjectData.id), subjectData);
            };
            const dbDeleteSubject = async (id) => {
                if(!db) return;
                const { doc, deleteDoc } = window.firebaseModules;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects_v1', id));
            };
            const dbSaveRejection = async (data) => {
                if(!db) throw new Error("Database belum terhubung");
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rejected_students_v1', String(data.studentId)), data);
            };
            const dbDeleteRejection = async (id) => {
                if(!db) return;
                const { doc, deleteDoc } = window.firebaseModules;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rejected_students_v1', String(id)));
            };

            const handleAddSubject = (e) => {
                e.preventDefault();
                if (!newSubjectName.trim()) return;
                const id = newSubjectName.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 10) + Date.now().toString().slice(-3);
                const existing = subjects.find(s => s.name.toLowerCase() === newSubjectName.toLowerCase());
                if (existing) {
                    if (!existing.levels.includes(activeLevelTab)) dbSaveSubject({ ...existing, levels: [...existing.levels, activeLevelTab] });
                } else dbSaveSubject({ id, name: newSubjectName, levels: [activeLevelTab] });
                setNewSubjectName("");
            };
            const handleDeleteSubjectFromLevel = (subjectId, level) => {
                if(confirm("Hapus mata pelajaran ini?")) {
                    const subject = subjects.find(s => s.id === subjectId);
                    if(subject) {
                        const newLevels = subject.levels.filter(l => l !== level);
                        if (newLevels.length > 0) dbSaveSubject({ ...subject, levels: newLevels });
                        else dbDeleteSubject(subjectId);
                    }
                }
            };
            const getSubjectsByLevel = (level) => subjects.filter(s => s.levels.includes(level));
            
            const calculateGrandTotal = (student) => {
                let total = 0;
                SEMESTERS.forEach(sem => getSubjectsByLevel(sem.level).forEach(sub => total += (student.grades?.[sem.id]?.[sub.id] || 0)));
                return total;
            };
            const calculateAverage = (student) => {
                let total = 0, count = 0;
                SEMESTERS.forEach(sem => getSubjectsByLevel(sem.level).forEach(sub => { total += (student.grades?.[sem.id]?.[sub.id] || 0); count++; }));
                return count === 0 ? "0.00" : (total / count).toFixed(2);
            };
            const calculateSemesterAverage = (student, semId) => {
                const semInfo = SEMESTERS.find(s => s.id === semId);
                const semSubjects = getSubjectsByLevel(semInfo.level);
                let total = 0;
                let count = 0;
                semSubjects.forEach(sub => {
                    total += (student.grades?.[semId]?.[sub.id] || 0);
                    count++;
                });
                return count === 0 ? "0.00" : (total / count).toFixed(2);
            };

            const uniqueClasses = useMemo(() => {
                const classes = students.map(s => s.class).filter(Boolean).map(c => c.trim().toUpperCase());
                return [...new Set(classes)].sort();
            }, [students]);

            const getProcessedRankings = (filterClass) => {
                let filteredList = [...students];
                if (filterClass !== 'ALL') {
                    filteredList = filteredList.filter(s => s.class && s.class.trim().toUpperCase() === filterClass);
                }
                const calculatedList = filteredList.map(s => ({
                    ...s,
                    grandTotal: calculateGrandTotal(s),
                    average: calculateAverage(s)
                }));
                calculatedList.sort((a, b) => b.grandTotal - a.grandTotal);
                return calculatedList.map((s, index) => ({
                    ...s,
                    rank: index + 1
                }));
            };

            const rankedStudentsGlobal = useMemo(() => getProcessedRankings('ALL'), [students, subjects]);

            const handleSaveStudent = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const studentData = {
                    id: editingStudent ? editingStudent.id : Date.now(),
                    name: formData.get('name'),
                    nis: formData.get('nis'),
                    nisn: formData.get('nisn'), 
                    class: formData.get('class'),
                    grades: currentGrades 
                };
                await dbSaveStudent(studentData);
                setIsModalOpen(false);
            };

            const handleDelete = async (id) => { if(confirm("Hapus siswa ini?")) await dbDeleteStudent(id); };

            const handleDownloadRankings = (dataToExport, filterName) => {
                if (dataToExport.length === 0) return alert("Belum ada data siswa.");
                const headers = ["Peringkat", "NIS", "NISN", "Nama Siswa", "Kelas", "Rerata S1", "Rerata S2", "Rerata S3", "Rerata S4", "Rerata S5", "Rata-rata Total", "Grand Total"];
                const data = dataToExport.map(s => {
                    const row = [s.rank, s.nis, s.nisn || "-", s.name, s.class];
                    [1, 2, 3, 4, 5].forEach(semId => row.push(calculateSemesterAverage(s, semId)));
                    row.push(s.average);
                    row.push(s.grandTotal);
                    return row;
                });
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Peringkat");
                const fileName = `PERINGKAT_${filterName.replace(/ /g, '_')}_STAR.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            const handleDownloadEligible = (list, filterName) => {
                if (list.length === 0) return alert("Tidak ada siswa eligible.");
                const headers = ["Peringkat", "NIS", "NISN", "Nama Siswa", "Kelas", "Rerata S1", "Rerata S2", "Rerata S3", "Rerata S4", "Rerata S5", "Rata-rata Total", "Grand Total", "Status SNBP"];
                const data = list.map(s => {
                    const row = [s.rank, s.nis, s.nisn || "-", s.name, s.class];
                     [1, 2, 3, 4, 5].forEach(semId => row.push(calculateSemesterAverage(s, semId)));
                    row.push(s.average); 
                    row.push(s.grandTotal);
                    if (s.isRejected) row.push(`MENOLAK - ${s.rejectReason}`);
                    else row.push("ELIGIBLE");
                    return row;
                });
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Eligible");
                XLSX.writeFile(wb, `ELIGIBLE_${filterName.replace(/ /g, '_')}_STAR.xlsx`);
            };

            const handleExportFullData = () => {
                const headers = ["NIS", "NISN", "NAMA SISWA", "KELAS", "SEMESTER", ...subjects.map(s => s.name.toUpperCase()), "TOTAL (SEM)", "RERATA (SEM)", "TOTAL AKUMULASI", "RERATA (TOTAL)", "PERINGKAT"];
                const dataRows = [];
                const semesterMap = { 1: "Sem 1", 2: "Sem 2", 3: "Sem 3", 4: "Sem 4", 5: "Sem 5" };
                const studentStatsMap = {};
                rankedStudentsGlobal.forEach(s => studentStatsMap[s.nis] = s);

                students.forEach(student => {
                    const stats = studentStatsMap[student.nis] || { grandTotal: 0, average: "0.00", rank: '-' };
                    SEMESTERS.forEach((sem, semIdx) => {
                        const row = [student.nis, student.nisn || "-", student.name, student.class || "-", semesterMap[sem.id]];
                        let semTotal = 0, count = 0;
                        subjects.forEach(sub => {
                            if (sub.levels.includes(sem.level)) {
                                const val = student.grades?.[sem.id]?.[sub.id] || 0;
                                row.push(val === 0 ? "" : val);
                                semTotal += val; count++;
                            } else { row.push("-"); }
                        });
                        const semAvg = count > 0 ? (semTotal/count).toFixed(2) : "0.00";
                        row.push(semTotal); 
                        row.push(semAvg);

                        if (semIdx === 0) { row.push(stats.grandTotal); row.push(stats.average); row.push(stats.rank); } else { row.push(""); row.push(""); row.push(""); }
                        dataRows.push(row);
                    });
                });
                const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);
                const merges = [];
                let rStart = 1;
                const idxTot = headers.length - 3;
                const idxAvg = headers.length - 2;
                const idxRank = headers.length - 1;
                students.forEach(() => {
                    for(let c=0; c<=3; c++) merges.push({s:{r:rStart, c:c}, e:{r:rStart+4, c:c}});
                    merges.push({s:{r:rStart, c:idxTot}, e:{r:rStart+4, c:idxTot}});
                    merges.push({s:{r:rStart, c:idxAvg}, e:{r:rStart+4, c:idxAvg}});
                    merges.push({s:{r:rStart, c:idxRank}, e:{r:rStart+4, c:idxRank}});
                    rStart += 5;
                });
                ws['!merges'] = merges;
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap Master");
                XLSX.writeFile(wb, "REKAP_MASTER_STAR.xlsx");
            };

            const handleDownloadTemplate = () => {
                const semInfo = SEMESTERS.find(s => s.id === importSemester);
                const semSubjects = getSubjectsByLevel(semInfo.level);
                const headers = ["NIS", "NISN", "KELAS", "NAMA SISWA", ...semSubjects.map(s => s.name.toUpperCase())];
                let dataRows = students.length > 0 
                    ? students.map(s => [s.nis, s.nisn||"", s.class||"", s.name, ...semSubjects.map(()=>"")])
                    : [["12345", "0012345", "10 IPA 1", "Siswa Baru", ...semSubjects.map(()=>"")]];
                
                const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, `TEMPLATE_${semInfo.label}.xlsx`);
            };

            const processImportData = (rows) => {
                const semInfo = SEMESTERS.find(s => s.id === importSemester);
                const semSubjects = getSubjectsByLevel(semInfo.level);
                const headers = rows[0].map(h => String(h).trim().toUpperCase());
                const idxNIS = headers.findIndex(h => h.includes("NIS"));
                const idxNISN = headers.findIndex(h => h.includes("NISN")); 
                
                if (idxNIS === -1) { alert("Header NIS tidak ditemukan"); return; }
                const subMap = {};
                semSubjects.forEach(s => { 
                    const idx = headers.findIndex(h => h === s.name.toUpperCase() || (s.alias && s.alias.includes(h)));
                    if(idx !== -1) subMap[s.id] = idx;
                });
                const results = [];
                let up=0, nw=0;
                for(let i=1; i<rows.length; i++) {
                    const row = rows[i];
                    if(!row || !row[idxNIS]) continue;
                    const nis = String(row[idxNIS]).trim();
                    const nisn = idxNISN !== -1 ? String(row[idxNISN] || "").trim() : "";
                    const match = students.find(s => s.nis === nis);
                    const grades = {};
                    let rowTotal = 0, rowCount = 0;
                    semSubjects.forEach(s => {
                        const val = subMap[s.id] !== undefined ? (parseInt(row[subMap[s.id]]) || 0) : 0;
                        grades[s.id] = val;
                        rowTotal += val; rowCount++;
                    });
                    
                    let nameVal = "Siswa Baru";
                    let classVal = "";
                    const idxName = headers.findIndex(h => h.includes("NAMA"));
                    const idxClass = headers.findIndex(h => h.includes("KELAS"));
                    
                    if (idxName !== -1) nameVal = row[idxName];
                    else if (match) nameVal = match.name;
                    else nameVal = row[idxNIS + (idxNISN!==-1?3:2)] || "Siswa Baru";

                    if (idxClass !== -1) classVal = row[idxClass];
                    else if (match) classVal = match.class;
                    else classVal = row[idxNIS + (idxNISN!==-1?2:1)] || "";

                    results.push({
                        nis, 
                        nisn: nisn || (match ? match.nisn : ""),
                        name: nameVal,
                        class: classVal,
                        status: match ? 'existing' : 'new',
                        studentId: match ? match.id : null,
                        grades,
                        total: rowTotal,
                        average: rowCount > 0 ? (rowTotal/rowCount).toFixed(2) : "0.00"
                    });
                    if(match) up++; else nw++;
                }
                setPreviewData(results);
                setImportStats({updated: up, new: nw, invalid: 0});
                setImportStage('preview');
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, {type:'binary'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    processImportData(XLSX.utils.sheet_to_json(ws, {header:1}));
                };
                reader.readAsBinaryString(file);
            };
            
            const handlePasteData = (rawText, semId, subjectsList) => {
                const values = rawText.trim().split(/[\t, ]+/);
                const newSemGrades = { ...(currentGrades[semId] || {}) };
                subjectsList.forEach((sub, index) => {
                    if (index < values.length) newSemGrades[sub.id] = parseInt(values[index]) || 0;
                });
                setCurrentGrades(prev => ({...prev, [semId]: newSemGrades}));
                setPasteMode(false);
            };

            const handleConfirmImport = async () => {
                setLoading(true);
                let processed = 0;
                try {
                    for (const row of previewData) {
                        if (row.status === 'existing' && row.studentId) {
                            const existingStudent = students.find(s => s.id === row.studentId);
                            if (existingStudent) {
                                const updatedStudent = { ...existingStudent };
                                if (row.class) updatedStudent.class = row.class;
                                if (row.nisn) updatedStudent.nisn = row.nisn;
                                if (!updatedStudent.grades) updatedStudent.grades = {};
                                if (!updatedStudent.grades[importSemester]) updatedStudent.grades[importSemester] = {};
                                Object.keys(row.grades).forEach(subjectId => updatedStudent.grades[importSemester][subjectId] = row.grades[subjectId]);
                                await dbSaveStudent(updatedStudent);
                            }
                        } else if (row.status === 'new') {
                            const newId = Date.now() + Math.floor(Math.random() * 10000);
                            const newStudent = { id: newId, name: row.name, nis: row.nis, nisn: row.nisn, class: row.class, grades: {} };
                            newStudent.grades[importSemester] = row.grades;
                            await dbSaveStudent(newStudent);
                        }
                        processed++;
                    }
                    alert(`Import Selesai! ${processed} data berhasil diproses ke Database.`);
                } catch (error) {
                    console.error(error);
                    alert("Terjadi kesalahan saat menyimpan import: " + error.message);
                } finally {
                    setLoading(false);
                    setImportStage('upload'); 
                    setIsImportModalOpen(false);
                }
             };

            const handleSaveRejection = async () => {
                setIsSavingRejection(true);
                try {
                    if(!selectedRejectStudent || !rejectReason) {
                        throw new Error("Mohon pilih siswa dari hasil pencarian dan isi alasan penolakan.");
                    }
                    
                    await dbSaveRejection({
                        studentId: selectedRejectStudent.id,
                        name: selectedRejectStudent.name,
                        nis: selectedRejectStudent.nis,
                        nisn: selectedRejectStudent.nisn || "-",
                        reason: rejectReason
                    });
                    
                    setSelectedRejectStudent(null);
                    setRejectReason("");
                    setRejectSearch("");
                    alert("Data berhasil disimpan ke database.");
                } catch (error) {
                    console.error("Gagal menyimpan:", error);
                    alert("Gagal menyimpan: " + error.message);
                } finally {
                    setIsSavingRejection(false);
                }
            };

            const handleDeleteRejection = async (id) => {
                if(confirm("Hapus data penolakan ini? Siswa akan kembali masuk daftar Eligible.")) {
                    try {
                        await dbDeleteRejection(id);
                    } catch (error) {
                        alert("Gagal menghapus: " + error.message);
                    }
                }
            };

            // --- VIEW RENDERERS ---
            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card title="Total Siswa" value={students.length} icon={<Users size={24}/>} color="bg-blue-500" />
                        <Card title="Rata-rata Angkatan" value={rankedStudentsGlobal.length > 0 ? (rankedStudentsGlobal.reduce((acc, curr) => acc + parseFloat(curr.average), 0) / rankedStudentsGlobal.length).toFixed(2) : "0.00"} icon={<BarChart3 size={24}/>} color="bg-emerald-500" />
                        <Card title="Juara Umum" value={rankedStudentsGlobal.length > 0 ? rankedStudentsGlobal[0].name : "-"} icon={<Trophy size={24}/>} color="bg-amber-500" />
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border p-6">
                        <h3 className="font-bold text-lg mb-4">Top 5 Siswa Terbaik (Angkatan)</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 font-bold text-slate-700"><tr><th className="p-3 w-12 text-center">Rank</th><th className="p-3 min-w-[200px]">Nama Siswa</th><th className="p-3 text-center">Sem 1</th><th className="p-3 text-center">Sem 2</th><th className="p-3 text-center">Sem 3</th><th className="p-3 text-center">Sem 4</th><th className="p-3 text-center">Sem 5</th><th className="p-3 text-right text-blue-700">Total Nilai Semester</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {rankedStudentsGlobal.slice(0, 5).map(s => {
                                        const semTotals = [1, 2, 3, 4, 5].map(semId => {
                                            const semInfo = SEMESTERS.find(sem => sem.id === semId);
                                            const semSubjects = getSubjectsByLevel(semInfo.level);
                                            return semSubjects.reduce((acc, sub) => acc + (s.grades?.[semId]?.[sub.id] || 0), 0);
                                        });
                                        return (
                                            <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-3 text-center"><span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${s.rank <= 3 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>{s.rank}</span></td>
                                                <td className="p-3 font-medium text-slate-900">{s.name}</td>
                                                {semTotals.map((total, idx) => (<td key={idx} className="p-3 text-center text-slate-500 font-mono text-xs">{total > 0 ? total : "-"}</td>))}
                                                <td className="p-3 text-right font-bold text-blue-600 font-mono text-base">{s.grandTotal}</td>
                                            </tr>
                                        );
                                    })}
                                    {rankedStudentsGlobal.length === 0 && (<tr><td colSpan="8" className="p-8 text-center text-slate-400 italic">Belum ada data siswa untuk ditampilkan.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );

            const renderDataInput = () => (
                <div className="bg-white rounded-xl shadow-sm border p-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-lg">Data Siswa</h3>
                        <div className="flex gap-2">
                             <button onClick={()=>setIsSubjectModalOpen(true)} className="px-3 py-2 bg-slate-100 rounded text-sm hover:bg-slate-200"><BookOpen size={16}/> Atur Mapel</button>
                            <button onClick={()=>{setIsImportModalOpen(true); setImportStage('upload');}} className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700"><FileUp size={16}/> Import Excel</button>
                            <button onClick={()=>{setEditingStudent(null); setIsModalOpen(true);}} className="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"><Plus size={16}/> Tambah</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 font-bold"><tr><th className="p-3">NIS</th><th className="p-3">NISN</th><th className="p-3">Nama</th><th className="p-3">Kelas</th><th className="p-3 text-center">Total (5 Sem)</th><th className="p-3 text-center">Rerata Total</th><th className="p-3 text-right">Aksi</th></tr></thead>
                            <tbody>
                                {students.map(s => {
                                    const total = calculateGrandTotal(s);
                                    const avg = calculateAverage(s);
                                    return (
                                        <tr key={s.id} className="border-b hover:bg-slate-50">
                                            <td className="p-3 font-mono">{s.nis}</td>
                                            <td className="p-3 font-mono text-slate-600">{s.nisn || "-"}</td>
                                            <td className="p-3">{s.name}</td><td className="p-3">{s.class}</td><td className="p-3 text-center font-bold text-blue-700">{total}</td><td className="p-3 text-center">{avg}</td>
                                            <td className="p-3 text-right space-x-2"><button onClick={()=>{setEditingStudent(s); setIsModalOpen(true);}} className="text-blue-600 hover:underline">Edit/Nilai</button><button onClick={()=>handleDelete(s.id)} className="text-red-600 hover:underline">Hapus</button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const renderRankings = () => {
                const displayedRankings = getProcessedRankings(rankFilter);
                return (
                    <div className="bg-white rounded-xl shadow-sm border p-6 animate-fade-in">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Trophy size={20} className="text-amber-500"/> Peringkat Siswa</h3><p className="text-xs text-slate-500">Urutan berdasarkan Total Nilai (5 Semester)</p></div>
                            <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                <div className="relative">
                                    <Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
                                    <select value={rankFilter} onChange={(e) => setRankFilter(e.target.value)} className="pl-10 pr-4 py-2 border rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-48 appearance-none">
                                        <option value="ALL">Semua Angkatan</option>
                                        {uniqueClasses.map(cls => (<option key={cls} value={cls}>Kelas {cls}</option>))}
                                    </select>
                                </div>
                                <button onClick={() => handleDownloadRankings(displayedRankings, rankFilter === 'ALL' ? 'Semua Angkatan' : rankFilter)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-colors"><Download size={16}/> Download Excel</button>
                            </div>
                        </div>
                        <div className="relative mb-4">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
                            <input type="text" placeholder="Cari nama siswa di daftar ini..." className="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full" onChange={(e) => setSearchTerm(e.target.value.toLowerCase())}/>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 font-bold text-slate-700"><tr><th className="p-3 w-16 text-center">Rank</th><th className="p-3">NIS</th><th className="p-3">NISN</th><th className="p-3">Kelas</th><th className="p-3 min-w-[200px]">Nama Siswa</th><th className="p-3 text-center text-xs">Rerata S1</th><th className="p-3 text-center text-xs">Rerata S2</th><th className="p-3 text-center text-xs">Rerata S3</th><th className="p-3 text-center text-xs">Rerata S4</th><th className="p-3 text-center text-xs">Rerata S5</th><th className="p-3 text-right">Rerata Total</th><th className="p-3 text-right font-bold text-blue-700">Total Nilai</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {displayedRankings.filter(s => s.name.toLowerCase().includes(searchTerm)).map(s => (
                                            <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="p-3 text-center"><span className={`inline-flex items-center justify-center w-8 h-8 rounded-full font-bold text-xs ${s.rank <= 3 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>#{s.rank}</span></td>
                                                <td className="p-3 font-mono text-slate-500">{s.nis}</td>
                                                <td className="p-3 font-mono text-slate-500">{s.nisn || "-"}</td>
                                                <td className="p-3 font-medium text-slate-600">{s.class}</td>
                                                <td className="p-3 font-bold text-slate-800">{s.name}</td>
                                                <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 1)}</td>
                                                <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 2)}</td>
                                                <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 3)}</td>
                                                <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 4)}</td>
                                                <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 5)}</td>
                                                <td className="p-3 text-right font-mono">{s.average}</td><td className="p-3 text-right font-bold text-blue-600 text-lg">{s.grandTotal}</td>
                                            </tr>
                                    ))
                                    }
                                    {displayedRankings.length === 0 && (<tr><td colSpan="12" className="p-8 text-center text-slate-400 italic">Tidak ada data untuk filter ini.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderEligible = () => {
                const processedList = getProcessedRankings(eligibleFilter);
                // --- FIX: Paksa konversi ke String untuk perbandingan ID yang aman (Angka vs String) ---
                const rejectedIds = rejectedStudents.map(r => String(r.studentId));
                
                // Filter siswa yang tidak menolak
                const availableStudents = processedList.filter(s => !rejectedIds.includes(String(s.id)));
                
                // --- RE-RANKING LOGIC ---
                // Urutkan ulang ranking dari 1 untuk siswa yang tersedia (Eligible)
                // Kita simpan ranking asli di 'originalRank' jika sewaktu-waktu dibutuhkan
                const reRankedAvailable = availableStudents.map((s, index) => ({
                    ...s,
                    originalRank: s.rank, // Simpan ranking global asli
                    rank: index + 1       // Ranking baru khusus menu Eligible (urut 1, 2, 3...)
                }));
                // ------------------------

                const eligibleList = reRankedAvailable.slice(0, eligibleQuota);
                
                // Persiapkan data download
                // Kita tidak melakukan sort ulang berdasarkan rank campuran agar urutan Eligible (1-N) tetap diatas
                const downloadList = [...eligibleList];
                
                rejectedStudents.forEach(rej => {
                    const studentData = processedList.find(s => String(s.id) === String(rej.studentId));
                    if (studentData) {
                        // Siswa rejected tetap menggunakan ranking global aslinya atau ditandai khusus
                        // Di sini kita biarkan ranking globalnya, tapi di excel nanti akan ada di bawah
                        downloadList.push({ ...studentData, isRejected: true, rejectReason: rej.reason });
                    }
                });
                
                // Hapus sorting global rank agar list download mengikuti urutan: Eligible (urut 1-N) baru kemudian Rejected
                // downloadList.sort((a, b) => a.rank - b.rank); <--- DIHAPUS

                return (
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                        <div className="p-6 border-b border-slate-100">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Award size={20} className="text-purple-600"/> Siswa Eligible (SNBP)</h3><p className="text-sm text-slate-500">Tentukan kuota siswa terbaik berdasarkan filter.</p></div>
                                <div className="flex flex-wrap items-center gap-2 w-full md:w-auto">
                                    <div className="relative">
                                        <Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={14} />
                                        <select value={eligibleFilter} onChange={(e) => setEligibleFilter(e.target.value)} className="pl-9 pr-8 py-2 border rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none font-medium text-slate-700">
                                            <option value="ALL">Semua Angkatan</option>
                                            {uniqueClasses.map(cls => (<option key={cls} value={cls}>Kelas {cls}</option>))}
                                        </select>
                                    </div>
                                    <div className="flex items-center border rounded-lg overflow-hidden bg-white">
                                        <span className="px-3 py-2 bg-slate-50 text-slate-500 text-sm font-medium border-r">Kuota</span>
                                        <input type="number" min="1" max={reRankedAvailable.length} value={eligibleQuota} onChange={(e) => setEligibleQuota(parseInt(e.target.value) || 0)} className="w-16 px-2 py-2 text-center font-bold outline-none text-purple-700"/>
                                    </div>
                                    <button onClick={() => handleDownloadEligible(downloadList, eligibleFilter === 'ALL' ? 'Semua Angkatan' : eligibleFilter)} className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors ml-auto md:ml-0"><Download size={16}/> Download Excel</button>
                                </div>
                            </div>
                            <div className="bg-purple-50 text-purple-800 text-sm p-3 rounded border border-purple-100 flex items-center gap-2"><CheckCircle size={16} /> Menampilkan <b>{eligibleList.length}</b> siswa terbaik dari total {reRankedAvailable.length} siswa tersedia ({eligibleFilter === 'ALL' ? 'Satu Angkatan' : `Kelas ${eligibleFilter}`}).</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-purple-100 font-bold text-purple-900">
                                    <tr>
                                        <th className="p-3 w-16 text-center">Rank</th><th className="p-3">NIS</th><th className="p-3">NISN</th><th className="p-3">Kelas</th><th className="p-3 min-w-[200px]">Nama Siswa</th><th className="p-3 text-center text-xs">Rerata S1</th><th className="p-3 text-center text-xs">Rerata S2</th><th className="p-3 text-center text-xs">Rerata S3</th><th className="p-3 text-center text-xs">Rerata S4</th><th className="p-3 text-center text-xs">Rerata S5</th><th className="p-3 text-right">Rerata Total</th><th className="p-3 text-right font-bold">Total Nilai</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {eligibleList.map((s) => (
                                        <tr key={s.id} className="hover:bg-purple-50/50 transition-colors">
                                            <td className="p-3 text-center font-bold text-slate-700">#{s.rank}</td>
                                            <td className="p-3 font-mono text-xs">{s.nis}</td>
                                            <td className="p-3 font-mono text-xs">{s.nisn || "-"}</td>
                                            <td className="p-3 font-medium">{s.class}</td>
                                            <td className="p-3 font-medium text-slate-900">{s.name}</td>
                                            <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 1)}</td>
                                            <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 2)}</td>
                                            <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 3)}</td>
                                            <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 4)}</td>
                                            <td className="p-3 text-center font-mono text-xs text-slate-500">{calculateSemesterAverage(s, 5)}</td>
                                            <td className="p-3 text-right font-mono">{s.average}</td>
                                            <td className="p-3 text-right font-bold text-purple-700 text-lg">{s.grandTotal}</td>
                                        </tr>
                                    ))}
                                    {eligibleList.length === 0 && (<tr><td colSpan="12" className="p-8 text-center text-slate-400 italic">Tidak ada siswa eligible untuk kriteria ini.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderRejectedMenu = () => (
                <div className="bg-white rounded-xl shadow-sm border p-6 animate-fade-in">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><UserMinus className="text-red-600" size={20}/> Manajemen Siswa Menolak Eligible</h3>
                    <div className="mb-6 p-4 bg-slate-50 border rounded-lg">
                        <h4 className="font-bold text-sm text-slate-700 mb-2">Input Siswa Menolak</h4>
                        <div className="flex flex-col md:flex-row gap-3">
                            <div className="flex-1 relative">
                                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
                                <input 
                                    type="text" 
                                    placeholder="Cari Nama/NIS..." 
                                    value={rejectSearch}
                                    onChange={(e) => {
                                        setRejectSearch(e.target.value.toLowerCase());
                                        setSelectedRejectStudent(null);
                                    }}
                                    className="pl-9 p-2 border rounded w-full text-sm"
                                />
                                {rejectSearch && !selectedRejectStudent && (
                                    <div className="absolute top-full left-0 right-0 bg-white border mt-1 max-h-40 overflow-y-auto z-10 shadow-lg rounded">
                                        {students.filter(s => s.name.toLowerCase().includes(rejectSearch) || s.nis.includes(rejectSearch)).slice(0, 5).map(s => (
                                            <div key={s.id} onClick={() => { setSelectedRejectStudent(s); setRejectSearch(s.name); }} className="p-2 hover:bg-blue-50 cursor-pointer text-sm flex items-center justify-between group">
                                                <div><span className="font-bold">{s.name}</span> <span className="text-slate-500 text-xs">({s.nis})</span></div>
                                                <UserCheck size={14} className="text-green-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <input 
                                type="text" 
                                placeholder="Alasan Menolak (Cth: Masuk Kedinasan)" 
                                value={rejectReason}
                                onChange={(e) => setRejectReason(e.target.value)}
                                className="flex-1 p-2 border rounded text-sm"
                            />
                            <button onClick={handleSaveRejection} disabled={isSavingRejection} className={`bg-red-600 text-white px-4 py-2 rounded text-sm font-medium ${isSavingRejection ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'}`}>{isSavingRejection ? 'Menyimpan...' : 'Simpan'}</button>
                        </div>
                        {selectedRejectStudent && (
                            <div className="mt-2 text-xs text-green-600 flex items-center gap-1 font-medium bg-green-50 p-2 rounded inline-block">
                                <UserCheck size={12}/> Siswa Terpilih: {selectedRejectStudent.name}
                            </div>
                        )}
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-red-50 text-red-900 font-bold"><tr><th className="p-3">NIS</th><th className="p-3">NISN</th><th className="p-3">Nama Siswa</th><th className="p-3">Alasan Menolak</th><th className="p-3 text-right">Aksi</th></tr></thead>
                            <tbody>
                                {rejectedStudents.length > 0 ? rejectedStudents.map(r => (
                                    <tr key={r.studentId} className="border-b">
                                        <td className="p-3 font-mono">{r.nis}</td>
                                        <td className="p-3 font-mono">{r.nisn || "-"}</td>
                                        <td className="p-3 font-bold">{r.name}</td>
                                        <td className="p-3 text-red-600 italic">{r.reason}</td>
                                        <td className="p-3 text-right"><button onClick={() => handleDeleteRejection(r.studentId)} className="text-slate-400 hover:text-red-600"><Trash2 size={16}/></button></td>
                                    </tr>
                                )) : <tr><td colSpan="5" className="p-8 text-center text-slate-400">Belum ada data siswa menolak.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const renderExport = () => (
                <div className="bg-white rounded-xl shadow-sm border p-12 text-center flex flex-col items-center animate-fade-in">
                    <div className="bg-green-100 p-6 rounded-full mb-4"><FileDown size={48} className="text-green-600"/></div>
                    <h3 className="font-bold text-xl mb-2">Export Data Master</h3>
                    <p className="text-slate-500 mb-6 max-w-md">Unduh seluruh data (Identitas + Nilai 5 Semester + Peringkat) dalam satu file Excel yang rapi.</p>
                    <button onClick={handleExportFullData} className="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg"><Download/> Download Excel Master</button>
                </div>
            );

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500 flex-col gap-2"><div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>Memuat Data Database...</div>;
            if (permissionError) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-8 bg-red-50 text-slate-800 animate-fade-in">
                        <AlertCircle size={64} className="text-red-500 mb-4"/>
                        <h1 className="text-2xl font-bold mb-2">Akses Database Ditolak</h1>
                        <p className="text-center max-w-xl mb-6">Aplikasi tidak diizinkan membaca/menulis ke database Firebase Anda.<br/>Ini karena <b>Security Rules</b> di Firebase Console belum diatur.</p>
                        <div className="bg-white p-6 rounded-lg shadow border border-slate-200 w-full max-w-2xl">
                            <h3 className="font-bold mb-2 flex items-center gap-2"><Settings size={18}/> Cara Memperbaiki:</h3>
                            <ol className="list-decimal list-inside text-sm space-y-2 mb-4">
                                <li>Buka <b>Firebase Console</b> > <b>Firestore Database</b> > Tab <b>Rules</b>.</li>
                                <li>Copy & Paste kode di bawah ini:</li>
                            </ol>
                            <div className="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto relative">
<pre>{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/{document=**} {
      allow read, write: if request.auth != null;
    }
    match /{document=**} {
      allow read, write: if false;
    }
  }
}`}</pre>
                            </div>
                            <p className="text-xs text-slate-500 mt-2">Klik <b>Publish</b> setelah paste.</p>
                        </div>
                        <button onClick={() => window.location.reload()} className="mt-8 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Sudah Diperbaiki? Refresh Halaman</button>
                    </div>
                )
            }

            return (
                <div className="min-h-screen flex font-sans text-slate-600">
                    {/* Sidebar */}
                    <div className="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:flex flex-col">
                        <div className="p-6 border-b border-slate-800">
                            <div className="flex items-center gap-2 text-blue-400 mb-1"><HeartHandshake size={24} /><span className="font-bold text-lg">STAR App</span></div>
                            <div className="text-[10px] text-slate-500 leading-tight mb-3">Sistem Tabulasi & Peringkat Rapor</div>
                            <div className="flex items-center gap-2 text-xs text-slate-400">
                                {isOnline ? <span className="text-green-400 flex items-center gap-1"><Cloud size={12}/> Online</span> : <span className="text-red-400 flex items-center gap-1"><WifiOff size={12}/> Offline/Demo</span>}
                            </div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setView('dashboard')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='dashboard'?'bg-blue-600':'hover:bg-slate-800'}`}><BarChart3 size={18}/> Dashboard</button>
                            <button onClick={()=>setView('input')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='input'?'bg-blue-600':'hover:bg-slate-800'}`}><FileSpreadsheet size={18}/> Input Data</button>
                            <button onClick={()=>setView('rankings')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='rankings'?'bg-blue-600':'hover:bg-slate-800'}`}><Trophy size={18}/> Peringkat</button>
                            <button onClick={()=>setView('eligible')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='eligible'?'bg-blue-600':'hover:bg-slate-800'}`}><Award size={18}/> Menu Eligible</button>
                            <button onClick={()=>setView('rejected')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='rejected'?'bg-blue-600':'hover:bg-slate-800'}`}><UserMinus size={18}/> Menolak Eligible</button>
                            <button onClick={()=>setView('export')} className={`w-full flex gap-3 px-4 py-3 rounded text-sm transition-colors ${view==='export'?'bg-blue-600':'hover:bg-slate-800'}`}><FileDown size={18}/> Export Data</button>
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-xs text-center text-slate-500">By Pak Dhani Gemoy BK Mojokerto</div>
                    </div>
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between"><span className="font-bold">STAR App</span></div>
                        <div className="flex-1 overflow-y-auto p-8">
                            {view === 'dashboard' && renderDashboard()}
                            {view === 'input' && renderDataInput()}
                            {view === 'rankings' && renderRankings()}
                            {view === 'eligible' && renderEligible()}
                            {view === 'rejected' && renderRejectedMenu()}
                            {view === 'export' && renderExport()}
                        </div>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={()=>setIsModalOpen(false)} title="Data Siswa">
                        <form onSubmit={handleSaveStudent} className="space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <input required name="nis" defaultValue={editingStudent?.nis} placeholder="NIS" className="border p-2 rounded" />
                                <input name="nisn" defaultValue={editingStudent?.nisn} placeholder="NISN" className="border p-2 rounded" />
                                <input required name="name" defaultValue={editingStudent?.name} placeholder="Nama" className="border p-2 rounded" />
                                <input required name="class" defaultValue={editingStudent?.class} placeholder="Kelas" className="border p-2 rounded" />
                            </div>
                            <div className="flex border-b mb-4 overflow-x-auto">
                                {SEMESTERS.map(s => (
                                    <button key={s.id} type="button" onClick={()=>setActiveSemesterInput(s.id)} className={`px-4 py-2 whitespace-nowrap ${activeSemesterInput===s.id ? 'border-b-2 border-blue-600 text-blue-600':''}`}>{s.label}</button>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {getSubjectsByLevel(SEMESTERS.find(s=>s.id===activeSemesterInput).level).map(sub => (
                                    <div key={`${activeSemesterInput}_${sub.id}`}>
                                        <label className="text-xs text-slate-500">{sub.name}</label>
                                        <input 
                                            type="number" 
                                            value={currentGrades[activeSemesterInput]?.[sub.id] || 0}
                                            onChange={(e) => updateCurrentGrades(activeSemesterInput, sub.id, e.target.value)}
                                            className="border p-2 rounded w-full text-center" 
                                        />
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-between items-center pt-4 border-t">
                                <button type="button" onClick={()=>setPasteMode(!pasteMode)} className="flex items-center gap-1 text-sm text-green-600 hover:text-green-800"><ClipboardPaste size={14}/> Paste Nilai (Excel)</button>
                                <div className="flex gap-2">
                                    <button type="button" onClick={()=>setIsModalOpen(false)} className="px-4 py-2 rounded hover:bg-slate-100">Batal</button>
                                    <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan</button>
                                </div>
                            </div>
                            {pasteMode && (
                                <div className="mt-2 p-2 bg-slate-50 border rounded animate-fade-in">
                                    <p className="text-xs mb-1 text-slate-500">Paste baris nilai dari Excel (urutan mapel harus sama):</p>
                                    <div className="flex gap-2">
                                        <input id="pasteInput" className="flex-1 border p-1 rounded text-xs" placeholder="Contoh: 80 90 85..."/>
                                        <button type="button" onClick={()=>{
                                            const val = document.getElementById('pasteInput').value;
                                            handlePasteData(val, activeSemesterInput, getSubjectsByLevel(SEMESTERS.find(s=>s.id===activeSemesterInput).level));
                                        }} className="bg-green-600 text-white px-3 rounded text-xs">Ok</button>
                                    </div>
                                </div>
                            )}
                        </form>
                    </Modal>
                    <Modal isOpen={isImportModalOpen} onClose={()=>setIsImportModalOpen(false)} title="Import Excel">
                         {importStage === 'upload' ? (
                             <div className="space-y-4">
                                <div className="flex justify-center mb-4 bg-slate-50 p-2 rounded-lg">
                                    {SEMESTERS.map(sem => (
                                        <button key={sem.id} onClick={()=>setImportSemester(sem.id)} className={`px-4 py-2 text-sm rounded transition-colors ${importSemester===sem.id ? 'bg-green-600 text-white font-bold shadow-md' : 'text-slate-600 hover:bg-slate-200'}`}>
                                            {sem.label}
                                        </button>
                                    ))}
                                </div>
                                <div className="text-center mb-4 p-4 border border-blue-100 bg-blue-50 rounded text-sm text-blue-800">
                                    Anda akan mengimport nilai untuk <b>{SEMESTERS.find(s=>s.id===importSemester).label}</b>
                                </div>
                                 <button onClick={handleDownloadTemplate} className="w-full border-2 border-dashed p-8 rounded text-center hover:bg-slate-50 border-slate-300 transition-colors">
                                    <Download className="mx-auto mb-2 text-slate-400"/>
                                    <span className="font-semibold text-slate-600">Download Template (Sesuai Semester)</span>
                                 </button>
                                 <input type="file" onChange={handleFileUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                             </div>
                         ) : (
                             <div>
                                 <div className="mb-4 bg-blue-50 p-3 rounded text-sm border border-blue-200">
                                     <h4 className="font-bold text-blue-900 mb-2">Preview Import Data ({SEMESTERS.find(s=>s.id===importSemester).label})</h4>
                                     <p>Siswa Baru: <b>{importStats.new}</b> | Update Data: <b>{importStats.updated}</b></p>
                                 </div>
                                 <div className="max-h-60 overflow-y-auto border rounded mb-4">
                                     <table className="spreadsheet-table w-full">
                                         <thead>
                                             <tr><th>NIS</th><th>NISN</th><th>Nama</th><th>Status</th><th>Total</th><th>Rata-rata</th></tr>
                                         </thead>
                                         <tbody>
                                             {previewData.map((row, i) => (
                                                 <tr key={i} className={row.status === 'new' ? 'new' : 'existing'}>
                                                     <td>{row.nis}</td>
                                                     <td>{row.nisn}</td>
                                                     <td>{row.name}</td>
                                                     <td>{row.status==='new' ? 'Baru' : 'Update'}</td>
                                                     <td className="font-bold">{row.total}</td>
                                                     <td>{row.average}</td>
                                                 </tr>
                                             ))}
                                         </tbody>
                                     </table>
                                 </div>
                                 <div className="flex gap-2">
                                     <button onClick={()=>{setImportStage('upload'); setPreviewData([]);}} className="px-4 py-2 border rounded hover:bg-slate-50">Batal</button>
                                     <button onClick={handleConfirmImport} className="bg-green-600 text-white flex-1 py-2 rounded hover:bg-green-700 font-bold">Simpan Ke Database</button>
                                 </div>
                             </div>
                         )}
                    </Modal>
                    <Modal isOpen={isSubjectModalOpen} onClose={()=>setIsSubjectModalOpen(false)} title="Atur Mapel">
                        <div className="space-y-4">
                            <div className="flex border-b">
                                {[10,11,12].map(l => <button key={l} onClick={()=>setActiveLevelTab(l)} className={`px-4 py-2 ${activeLevelTab===l?'border-b-2 border-blue-600':''}`}>Kls {l}</button>)}
                            </div>
                            <form onSubmit={handleAddSubject} className="flex gap-2">
                                <input value={newSubjectName} onChange={e=>setNewSubjectName(e.target.value)} placeholder="Nama Mapel..." className="border p-2 rounded flex-1"/>
                                <button className="bg-blue-600 text-white px-4 rounded">Tambah</button>
                            </form>
                            <div className="max-h-60 overflow-y-auto space-y-2">
                                {getSubjectsByLevel(activeLevelTab).map(s => (
                                    <div key={s.id} className="flex justify-between p-2 border rounded items-center hover:bg-slate-50">
                                        <span>{s.name}</span>
                                        <button onClick={()=>handleDeleteSubjectFromLevel(s.id, activeLevelTab)} className="text-red-500 text-xs bg-red-50 p-1 rounded hover:bg-red-100 flex items-center gap-1 font-bold border border-red-200"><Trash2 size={12}/> Hapus</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>